#!/usr/bin/env bash

# Future ideas
#  * Remove --share-net and switch to slirp4netns (doesn't work with --dev, see bubblewrap#332)

set -euo pipefail

cli="$(basename $0)"

if [[ "$#" -eq 0 ]]; then
  echo "Usage: $cli <sandbox> [command]"
  exit 1
fi

name="$1"
run_command="${2:-/bin/bash}"
run_chdir="$HOME"
sandbox_path="$HOME/.sandboxes/$name"

mkdir -p "$sandbox_path"

if [[ "$cli" == "bwshell" ]]; then
  mount_pwd=1
  run_chdir="$(pwd)"
fi

[[ "$cli" == "bwbox" && "$#" -eq 1 ]] && run_command="$name"

(exec bwrap --ro-bind /usr /usr \
      --bind $sandbox_path /home/martin \
      ${mount_pwd:+--bind $(pwd) $(pwd)} \
      --dir /tmp \
      --dir /var \
      --symlink ../tmp var/tmp \
      --proc /proc \
      --dev /dev \
      --ro-bind /etc/ca-certificates /etc/ca-certificates \
      --ro-bind /etc/ssl /etc/ssl \
      --ro-bind /etc/resolv.conf /etc/resolv.conf \
      --symlink usr/lib /lib \
      --symlink usr/lib64 /lib64 \
      --symlink usr/bin /bin \
      --symlink usr/sbin /sbin \
      --unshare-all \
      --share-net \
      --die-with-parent \
      --dir /run/user/$(id -u) \
      --setenv XDG_RUNTIME_DIR "/run/user/`id -u`" \
      --setenv PS1 "$name$ " \
      --hostname "$name" \
      --file 11 /etc/passwd \
      --file 12 /etc/group \
      --chdir "$run_chdir" \
      "$run_command") \
    11< <(getent passwd $UID 65534) \
    12< <(getent group $(id -g) 65534)
